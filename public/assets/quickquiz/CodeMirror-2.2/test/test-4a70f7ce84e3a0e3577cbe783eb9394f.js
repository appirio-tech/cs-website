function htmlEscape(a){return a.replace(/[<&]/g,function(a){return a=="&"?"&amp;":"&lt;"})}function forEach(a,b){for(var c=0,d=a.length;c<d;++c)b(a[c])}function Failure(a){this.message=a}function test(a,b){tests.push({name:a,func:b})}function testCM(a,b,c){test(a,function(){var a=document.getElementById("testground"),d=CodeMirror(a,c);try{b(d)}finally{a.removeChild(d.getWrapperElement())}})}function runTests(){var a=[],b=0;for(var c=0;c<tests.length;++c){var d=tests[c];try{d.func()}catch(e){e instanceof Failure?a.push({type:"failure",test:d.name,text:e.message}):a.push({type:"error",test:d.name,text:e.toString()})}b++}var f=[b+" tests run."];a.length?forEach(a,function(a){f.push(a.test+': <span class="'+a.type+'">'+htmlEscape(a.text)+"</span>")}):f.push('<span class="ok">All passed.</span>'),document.getElementById("output").innerHTML=f.join("\n")}function eq(a,b,c){if(a!=b)throw new Failure(a+" != "+b+(c?" ("+c+")":""))}function eqPos(a,b,c){if(a==b)return;if(a==null||b==null)throw new Failure("comparing point to null");eq(a.line,b.line,c),eq(a.ch,b.ch,c)}function is(a,b){if(!a)throw new Failure("assertion failed"+(b?" ("+b+")":""))}var tests=[];test("fromTextArea",function(){var a=document.getElementById("code");a.value="CONTENT";var b=CodeMirror.fromTextArea(a);is(!a.offsetHeight),eq(b.getValue(),"CONTENT"),b.setValue("foo\nbar"),eq(b.getValue(),"foo\nbar"),b.save(),is(/^foo\r?\nbar$/.test(a.value)),b.setValue("xxx"),b.toTextArea(),is(a.offsetHeight),eq(a.value,"xxx")}),testCM("getRange",function(a){eq(a.getLine(0),"1234"),eq(a.getLine(1),"5678"),eq(a.getLine(2),null),eq(a.getLine(-1),null),eq(a.getRange({line:0,ch:0},{line:0,ch:3}),"123"),eq(a.getRange({line:0,ch:-1},{line:0,ch:200}),"1234"),eq(a.getRange({line:0,ch:2},{line:1,ch:2}),"34\n56"),eq(a.getRange({line:1,ch:2},{line:100,ch:0}),"78")},{value:"1234\n5678"}),testCM("replaceRange",function(a){eq(a.getValue(),""),a.replaceRange("foo\n",{line:0,ch:0}),eq(a.getValue(),"foo\n"),a.replaceRange("a\nb",{line:0,ch:1}),eq(a.getValue(),"fa\nboo\n"),eq(a.lineCount(),3),a.replaceRange("xyzzy",{line:0,ch:0},{line:1,ch:1}),eq(a.getValue(),"xyzzyoo\n"),a.replaceRange("abc",{line:0,ch:0},{line:10,ch:0}),eq(a.getValue(),"abc"),eq(a.lineCount(),1)}),testCM("selection",function(a){a.setSelection({line:0,ch:4},{line:2,ch:2}),is(a.somethingSelected()),eq(a.getSelection(),"11\n222222\n33"),eqPos(a.getCursor(!1),{line:2,ch:2}),eqPos(a.getCursor(!0),{line:0,ch:4}),a.setSelection({line:1,ch:0}),is(!a.somethingSelected()),eq(a.getSelection(),""),eqPos(a.getCursor(!0),{line:1,ch:0}),a.replaceSelection("abc"),eq(a.getSelection(),"abc"),eq(a.getValue(),"111111\nabc222222\n333333"),a.replaceSelection("def","end"),eq(a.getSelection(),""),eqPos(a.getCursor(!0),{line:1,ch:3}),a.setCursor({line:2,ch:1}),eqPos(a.getCursor(!0),{line:2,ch:1}),a.setCursor(1,2),eqPos(a.getCursor(!0),{line:1,ch:2})},{value:"111111\n222222\n333333"}),testCM("lines",function(a){eq(a.getLine(0),"111111"),eq(a.getLine(1),"222222"),eq(a.getLine(-1),null),a.removeLine(1),a.setLine(1,"abc"),eq(a.getValue(),"111111\nabc")},{value:"111111\n222222\n333333"}),testCM("indent",function(a){a.indentLine(1),eq(a.getLine(1),"   blah();"),a.setOption("indentUnit",8),a.indentLine(1),eq(a.getLine(1),"\tblah();")},{value:"if (x) {\nblah();\n}",indentUnit:3,indentWithTabs:!0,tabSize:8}),test("defaults",function(){var a=CodeMirror.defaults,b=CodeMirror.defaults={};for(var c in a)b[c]=a[c];b.indentUnit=5,b.value="uu",b.enterMode="keep",b.tabindex=55;var d=document.getElementById("testground"),e=CodeMirror(d);try{eq(e.getOption("indentUnit"),5),e.setOption("indentUnit",10),eq(b.indentUnit,5),eq(e.getValue(),"uu"),eq(e.getOption("enterMode"),"keep"),eq(e.getInputField().tabIndex,55)}finally{CodeMirror.defaults=a,d.removeChild(e.getWrapperElement())}}),testCM("lineInfo",function(a){eq(a.lineInfo(-1),null);var b=a.setMarker(1,"FOO","bar"),c=a.lineInfo(1);eq(c.text,"222222"),eq(c.markerText,"FOO"),eq(c.markerClass,"bar"),eq(c.line,1),eq(a.lineInfo(2).markerText,null),a.clearMarker(b),eq(a.lineInfo(1).markerText,null)},{value:"111111\n222222\n333333"}),testCM("coords",function(a){var b=a.getWrapperElement().getElementsByClassName("CodeMirror-scroll")[0];b.style.height="100px";var c=[];for(var d=0;d<200;++d)c.push("------------------------------"+d);a.setValue(c.join("\n"));var e=a.charCoords({line:0,ch:0}),f=a.charCoords({line:200,ch:30});is(e.x<f.x),is(e.y<f.y),is(e.y<e.yBot),b.scrollTop=100,a.refresh();var g=a.charCoords({line:0,ch:0});is(e.y>g.y),eq(e.x,g.x)}),testCM("coordsChar",function(a){var b=[];for(var c=0;c<70;++c)b.push("xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx");a.setValue(b.join("\n"));for(var d=0;d<35;d+=2)for(var e=0;e<70;e+=5){a.setCursor(e,d);var f=a.coordsChar(a.charCoords({line:e,ch:d}));eq(f.line,e),eq(f.ch,d)}}),testCM("posFromIndex",function(a){a.setValue("This function should\nconvert a zero based index\nto line and ch.");var b=[{index:-1,line:0,ch:0},{index:0,line:0,ch:0},{index:10,line:0,ch:10},{index:39,line:1,ch:18},{index:55,line:2,ch:7},{index:63,line:2,ch:15},{index:64,line:2,ch:15}];for(var c=0;c<b.length;c++){var d=b[c],e=a.posFromIndex(d.index);eq(e.line,d.line),eq(e.ch,d.ch),d.index>=0&&d.index<64&&eq(a.indexFromPos(e),d.index)}}),testCM("undo",function(a){a.setLine(0,"def"),eq(a.historySize().undo,1),a.undo(),eq(a.getValue(),"abc"),eq(a.historySize().undo,0),eq(a.historySize().redo,1),a.redo(),eq(a.getValue(),"def"),eq(a.historySize().undo,1),eq(a.historySize().redo,0),a.setValue("1\n\n\n2"),a.clearHistory(),eq(a.historySize().undo,0);for(var b=0;b<20;++b)a.replaceRange("a",{line:0,ch:0}),a.replaceRange("b",{line:3,ch:0});eq(a.historySize().undo,40);for(var b=0;b<38;++b)a.undo();eq(a.historySize().undo,2),eq(a.historySize().redo,38),eq(a.getValue(),"a1\n\n\nb2"),a.setOption("undoDepth",10);for(var b=0;b<20;++b)a.replaceRange("a",{line:0,ch:0}),a.replaceRange("b",{line:3,ch:0});eq(a.historySize().undo,10)},{value:"abc"}),testCM("undoMultiLine",function(a){a.replaceRange("x",{line:0,ch:0}),a.replaceRange("y",{line:1,ch:0}),a.undo(),eq(a.getValue(),"abc\ndef\nghi"),a.replaceRange("y",{line:1,ch:0}),a.replaceRange("x",{line:0,ch:0}),a.undo(),eq(a.getValue(),"abc\ndef\nghi"),a.replaceRange("y",{line:2,ch:0}),a.replaceRange("x",{line:1,ch:0}),a.replaceRange("z",{line:2,ch:0}),a.undo(),eq(a.getValue(),"abc\ndef\nghi")},{value:"abc\ndef\nghi"}),testCM("markTextSingleLine",function(a){forEach([{a:0,b:1,c:"",f:2,t:5},{a:0,b:4,c:"",f:0,t:2},{a:1,b:2,c:"x",f:3,t:6},{a:4,b:5,c:"",f:3,t:5},{a:4,b:5,c:"xx",f:3,t:7},{a:2,b:5,c:"",f:2,t:3},{a:2,b:5,c:"abcd",f:6,t:7},{a:2,b:6,c:"x",f:null,t:null},{a:3,b:6,c:"",f:null,t:null},{a:0,b:9,c:"hallo",f:null,t:null},{a:4,b:6,c:"x",f:3,t:4},{a:4,b:8,c:"",f:3,t:4},{a:6,b:6,c:"a",f:3,t:6},{a:8,b:9,c:"",f:3,t:6}],function(b){a.setValue("1234567890");var c=a.markText({line:0,ch:3},{line:0,ch:6},"foo");a.replaceRange(b.c,{line:0,ch:b.a},{line:0,ch:b.b});var d=c.find();eq(d.from&&d.from.ch,b.f),eq(d.to&&d.to.ch,b.t)})}),testCM("markTextMultiLine",function(a){function b(a){return a&&{line:a[0],ch:a[1]}}forEach([{a:[0,0],b:[0,5],c:"",f:[0,0],t:[2,5]},{a:[0,1],b:[0,10],c:"",f:[0,1],t:[2,5]},{a:[0,5],b:[0,6],c:"x",f:[0,6],t:[2,5]},{a:[0,0],b:[1,0],c:"",f:[0,0],t:[1,5]},{a:[0,6],b:[2,4],c:"",f:[0,5],t:[0,7]},{a:[0,6],b:[2,4],c:"aa",f:[0,5],t:[0,9]},{a:[1,2],b:[1,8],c:"",f:[0,5],t:[2,5]},{a:[0,5],b:[2,5],c:"xx",f:null,t:null},{a:[0,0],b:[2,10],c:"x",f:null,t:null},{a:[1,5],b:[2,5],c:"",f:[0,5],t:[1,5]},{a:[2,0],b:[2,3],c:"",f:[0,5],t:[2,2]},{a:[2,5],b:[3,0],c:"a\nb",f:[0,5],t:[2,5]},{a:[2,3],b:[3,0],c:"x",f:[0,5],t:[2,3]},{a:[1,1],b:[1,9],c:"1\n2\n3",f:[0,5],t:[4,5]}],function(c){a.setValue("aaaaaaaaaa\nbbbbbbbbbb\ncccccccccc\ndddddddd\n");var d=a.markText({line:0,ch:5},{line:2,ch:5},"foo");a.replaceRange(c.c,b(c.a),b(c.b));var e=d.find();eqPos(e.from,b(c.f)),eqPos(e.to,b(c.t))})}),testCM("bookmark",function(a){function b(a){return a&&{line:a[0],ch:a[1]}}forEach([{a:[1,0],b:[1,1],c:"",d:[1,4]},{a:[1,1],b:[1,1],c:"xx",d:[1,7]},{a:[1,4],b:[1,5],c:"ab",d:[1,6]},{a:[1,4],b:[1,6],c:"",d:null},{a:[1,5],b:[1,6],c:"abc",d:[1,5]},{a:[1,6],b:[1,8],c:"",d:[1,5]},{a:[1,4],b:[1,4],c:"\n\n",d:[3,1]}],function(c){a.setValue("1234567890\n1234567890\n1234567890");var d=a.setBookmark({line:1,ch:5});a.replaceRange(c.c,b(c.a),b(c.b)),eqPos(d.find(),b(c.d))})}),window.onload=runTests