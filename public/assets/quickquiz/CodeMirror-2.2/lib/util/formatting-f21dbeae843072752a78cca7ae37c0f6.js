// ============== Formatting extensions ============================
// A common storage for all mode-specific formatting features
CodeMirror.modeExtensions||(CodeMirror.modeExtensions={}),CodeMirror.defineExtension("getModeExt",function(){return CodeMirror.modeExtensions[this.getOption("mode")]}),CodeMirror.defineExtension("getModeExtAtPos",function(a){var b=this.getTokenAt(a);return b&&b.state&&b.state.mode?CodeMirror.modeExtensions[b.state.mode=="html"?"htmlmixed":b.state.mode]:this.getModeExt()}),CodeMirror.defineExtension("commentRange",function(a,b,c){var d=this.getModeExtAtPos(this.getCursor());if(a){var e=this.getRange(b,c);this.replaceRange(d.commentStart+this.getRange(b,c)+d.commentEnd,b,c),b.line==c.line&&b.ch==c.ch&&this.setCursor(b.line,b.ch+d.commentStart.length)}else{var f=this.getRange(b,c),g=f.indexOf(d.commentStart),h=f.lastIndexOf(d.commentEnd);g>-1&&h>-1&&h>g&&(f=f.substr(0,g)+f.substring(g+d.commentStart.length,h)+f.substr(h+d.commentEnd.length)),this.replaceRange(f,b,c)}}),CodeMirror.defineExtension("autoIndentRange",function(a,b){var c=this;this.operation(function(){for(var d=a.line;d<=b.line;d++)c.indentLine(d)})}),CodeMirror.defineExtension("autoFormatRange",function(a,b){var c=this.indexFromPos(a),d=this.indexFromPos(b),e=this.getModeExt().autoFormatLineBreaks(this.getValue(),c,d),f=this;this.operation(function(){f.replaceRange(e,a,b);var d=f.posFromIndex(c).line,g=f.posFromIndex(c+e.length).line;for(var h=d;h<=g;h++)f.indentLine(h)})}),CodeMirror.modeExtensions.css={commentStart:"/*",commentEnd:"*/",wordWrapChars:[";","\\{","\\}"],autoFormatLineBreaks:function(a){return a.replace(new RegExp("(;|\\{|\\})([^\r\n])","g"),"$1\n$2")}},CodeMirror.modeExtensions.javascript={commentStart:"/*",commentEnd:"*/",wordWrapChars:[";","\\{","\\}"],getNonBreakableBlocks:function(a){var b=[new RegExp("for\\s*?\\(([\\s\\S]*?)\\)"),new RegExp("'([\\s\\S]*?)('|$)"),new RegExp('"([\\s\\S]*?)("|$)'),new RegExp("//.*([\r\n]|$)")],c=new Array;for(var d=0;d<b.length;d++){var e=0;while(e<a.length){var f=a.substr(e).match(b[d]);if(f!=null)c.push({start:e+f.index,end:e+f.index+f[0].length}),e+=f.index+Math.max(1,f[0].length);else break}}return c.sort(function(a,b){return a.start-b.start}),c},autoFormatLineBreaks:function(a){var b=0,c=new RegExp("(;|\\{|\\})([^\r\n])","g"),d=this.getNonBreakableBlocks(a);if(d!=null){var e="";for(var f=0;f<d.length;f++)d[f].start>b&&(e+=a.substring(b,d[f].start).replace(c,"$1\n$2"),b=d[f].start),d[f].start<=b&&d[f].end>=b&&(e+=a.substring(b,d[f].end),b=d[f].end);return b<a.length-1&&(e+=a.substr(b).replace(c,"$1\n$2")),e}return a.replace(c,"$1\n$2")}},CodeMirror.modeExtensions.xml={commentStart:"<!--",commentEnd:"-->",wordWrapChars:[">"],autoFormatLineBreaks:function(a){var b=a.split("\n"),c=new RegExp("(^\\s*?<|^[^<]*?)(.+)(>\\s*?$|[^>]*?$)"),d=new RegExp("<","g"),e=new RegExp("(>)([^\r\n])","g");for(var f=0;f<b.length;f++){var g=b[f].match(c);if(g!=null&&g.length>3){b[f]=g[1]+g[2].replace(d,"\n$&").replace(e,"$1\n$2")+g[3];continue}}return b.join("\n")}},CodeMirror.modeExtensions.htmlmixed={commentStart:"<!--",commentEnd:"-->",wordWrapChars:[">",";","\\{","\\}"],getModeInfos:function(a,b){var c=new Array;c[0]={pos:0,modeExt:CodeMirror.modeExtensions.xml,modeName:"xml"};var d=new Array;d[0]={regex:new RegExp("<style[^>]*>([\\s\\S]*?)(</style[^>]*>|$)","i"),modeExt:CodeMirror.modeExtensions.css,modeName:"css"},d[1]={regex:new RegExp("<script[^>]*>([\\s\\S]*?)(</script[^>]*>|$)","i"),modeExt:CodeMirror.modeExtensions.javascript,modeName:"javascript"};var e=typeof b!="undefined"?b:a.length-1;for(var f=0;f<d.length;f++){var g=0;while(g<=e){var h=a.substr(g).match(d[f].regex);if(h==null)break;if(h.length>1&&h[1].length>0){var i=g+h.index+h[0].indexOf(h[1]);c.push({pos:i,modeExt:d[f].modeExt,modeName:d[f].modeName}),c.push({pos:i+h[1].length,modeExt:c[0].modeExt,modeName:c[0].modeName}),g+=h.index+h[0].length;continue}g+=h.index+Math.max(h[0].length,1)}}return c.sort(function(a,b){return a.pos-b.pos}),c},autoFormatLineBreaks:function(a,b,c){var d=this.getModeInfos(a),e=new RegExp("^\\s*?\n"),f=new RegExp("\n\\s*?$"),g="";if(d.length>1)for(var h=1;h<=d.length;h++){var i=d[h-1].pos,j=h<d.length?d[h].pos:c;if(i>=c)break;if(i<b){if(j<=b)continue;i=b}j>c&&(j=c);var k=a.substring(i,j);d[h-1].modeName!="xml"&&(!e.test(k)&&i>0&&(k="\n"+k),!f.test(k)&&j<a.length-1&&(k+="\n")),g+=d[h-1].modeExt.autoFormatLineBreaks(k)}else g=d[0].modeExt.autoFormatLineBreaks(a.substring(b,c));return g}}