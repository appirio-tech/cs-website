// Define search commands. Depends on dialog.js or another
// implementation of the openDialog method.
// Replace works a little oddly -- it will do the replace on the next
// Ctrl-G (or whatever is bound to findNext) press. You prevent a
// replace by making sure the match is no longer selected when hitting
// Ctrl-G.
(function(){function a(){this.posFrom=this.posTo=this.query=null,this.marked=[]}function b(b){return b._searchState||(b._searchState=new a)}function c(a,b,c,d){a.openDialog?a.openDialog(b,d):d(prompt(c,""))}function d(a,b,c,d){a.openConfirm?a.openConfirm(b,d):confirm(c)&&d[0]()}function e(a){var b=a.match(/^\/(.*)\/$/);return b?new RegExp(b[1]):a}function g(a,d){var g=b(a);if(g.query)return h(a,d);c(a,f,"Search for:",function(b){a.operation(function(){if(!b||g.query)return;g.query=e(b);if(a.lineCount()<2e3)for(var c=a.getSearchCursor(b);c.findNext();)g.marked.push(a.markText(c.from(),c.to(),"CodeMirror-searching"));g.posFrom=g.posTo=a.getCursor(),h(a,d)})})}function h(a,c){a.operation(function(){var d=b(a),e=a.getSearchCursor(d.query,c?d.posFrom:d.posTo);if(!e.find(c)){e=a.getSearchCursor(d.query,c?{line:a.lineCount()-1}:{line:0,ch:0});if(!e.find(c))return}a.setSelection(e.from(),e.to()),d.posFrom=e.from(),d.posTo=e.to()})}function i(a){a.operation(function(){var c=b(a);if(!c.query)return;c.query=null;for(var d=0;d<c.marked.length;++d)c.marked[d].clear();c.marked.length=0})}function m(a,b){c(a,j,"Replace:",function(f){if(!f)return;f=e(f),c(a,k,"Replace with:",function(c){if(b)a.operation(function(){for(var b=a.getSearchCursor(f);b.findNext();)if(typeof f!="string"){var d=a.getRange(b.from(),b.to()).match(f);b.replace(c.replace(/\$(\d)/,function(a,b){return d[b]}))}else b.replace(c)});else{i(a);var e=a.getSearchCursor(f,a.getCursor());function g(){var b=e.from(),c;if(!(c=e.findNext())){e=a.getSearchCursor(f);if(!(c=e.findNext())||e.from().line==b.line&&e.from().ch==b.ch)return}a.setSelection(e.from(),e.to()),d(a,l,"Replace?",[function(){h(c)},g])}function h(a){e.replace(typeof f=="string"?c:c.replace(/\$(\d)/,function(b,c){return a[c]})),g()}g()}})})}var f='Search: <input type="text" style="width: 10em"> <span style="color: #888">(Use /re/ syntax for regexp search)</span>',j='Replace: <input type="text" style="width: 10em"> <span style="color: #888">(Use /re/ syntax for regexp search)</span>',k='With: <input type="text" style="width: 10em">',l="Replace? <button>Yes</button> <button>No</button> <button>Stop</button>";CodeMirror.commands.find=function(a){i(a),g(a)},CodeMirror.commands.findNext=g,CodeMirror.commands.findPrev=function(a){g(a,!0)},CodeMirror.commands.clearSearch=i,CodeMirror.commands.replace=m,CodeMirror.commands.replaceAll=function(a){m(a,!0)}})()